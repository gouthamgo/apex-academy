name: Direct Merge to Main

on:
  push:
    branches:
      - 'claude/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  build-test-merge:
    name: Build, Test and Merge
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        id: build
        run: |
          echo "Building Next.js application..."
          npm run build
          echo "build_status=success" >> $GITHUB_OUTPUT
        env:
          CI: true

      - name: Validate build
        run: |
          if [ ! -d ".next" ]; then
            echo "‚ùå Build failed - no .next directory found"
            exit 1
          fi
          echo "‚úÖ Build successful"

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Fetch main branch
        run: |
          git fetch origin main:main

      - name: Check for merge conflicts
        id: check-conflicts
        run: |
          git checkout main
          if git merge --no-commit --no-ff ${{ github.ref_name }}; then
            echo "No conflicts detected"
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
            git merge --abort
          else
            echo "‚ö†Ô∏è Merge conflicts detected"
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
            git merge --abort
            exit 1
          fi

      - name: Merge to main
        if: steps.check-conflicts.outputs.has_conflicts == 'false'
        run: |
          git checkout main
          git merge --no-ff ${{ github.ref_name }} -m "ü§ñ Auto-merge: ${{ github.ref_name }} ‚Üí main

          Automated merge from CI/CD pipeline

          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Build: ‚úÖ Passed

          [skip ci]"

      - name: Push to main
        if: steps.check-conflicts.outputs.has_conflicts == 'false'
        run: |
          git push origin main

      - name: Delete feature branch
        if: steps.check-conflicts.outputs.has_conflicts == 'false'
        run: |
          git push origin --delete ${{ github.ref_name }} || echo "Branch already deleted"

      - name: Create summary
        if: always()
        run: |
          echo "## üöÄ Merge Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ steps.build.outputs.build_status == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Conflicts | ${{ steps.check-conflicts.outputs.has_conflicts == 'false' && '‚úÖ None' || '‚ö†Ô∏è Detected' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Merge Status | ${{ success() && '‚úÖ Merged to main' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Auto-merge failed for ${{ github.ref_name }}"
          echo "Please check the logs and merge manually"
          exit 1
