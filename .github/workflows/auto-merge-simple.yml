name: Auto-Merge to Main (Simple)

on:
  push:
    branches:
      - 'claude/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  build-and-merge:
    name: Build and Auto-Merge
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          CI: true

      - name: Validate build
        run: |
          if [ ! -d ".next" ]; then
            echo "âŒ Build failed"
            exit 1
          fi
          echo "âœ… Build successful"

      - name: Create or update PR
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check if PR exists
          PR_NUMBER=$(gh pr list --head "${{ github.ref_name }}" --base main --json number --jq '.[0].number // empty')

          if [ -z "$PR_NUMBER" ]; then
            # Create new PR
            echo "Creating new PR..."
            PR_URL=$(gh pr create \
              --base main \
              --head "${{ github.ref_name }}" \
              --title "ðŸ¤– Auto-merge: $(echo ${{ github.ref_name }} | sed 's/claude\///')" \
              --body "## âœ… Automated Pull Request

          **Branch:** \`${{ github.ref_name }}\`
          **Build:** âœ… Passed
          **Commit:** \`${{ github.sha }}\`

          This PR was automatically created and will be merged to main.

          ---
          *Generated by GitHub Actions*")

            PR_NUMBER=$(echo $PR_URL | grep -oP '\d+$')
            echo "âœ… Created PR #$PR_NUMBER"
          else
            echo "âœ… PR #$PR_NUMBER already exists"
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Enabling auto-merge for PR #${{ steps.pr.outputs.pr_number }}..."
          gh pr merge ${{ steps.pr.outputs.pr_number }} --auto --merge --delete-branch || echo "Auto-merge enabled or already set"

      - name: Wait and check PR status
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Waiting for PR status checks..."
          sleep 5

          # Check if PR is still open
          PR_STATE=$(gh pr view ${{ steps.pr.outputs.pr_number }} --json state --jq '.state')

          if [ "$PR_STATE" == "MERGED" ]; then
            echo "âœ… PR already merged!"
          else
            echo "PR is $PR_STATE - auto-merge is enabled and will merge when all checks pass"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ðŸš€ Auto-Merge Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| PR | [#${{ steps.pr.outputs.pr_number }}](https://github.com/${{ github.repository }}/pull/${{ steps.pr.outputs.pr_number }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Auto-Merge | âœ… Enabled |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **PR will automatically merge to main when all checks pass**" >> $GITHUB_STEP_SUMMARY
