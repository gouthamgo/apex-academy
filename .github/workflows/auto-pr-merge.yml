name: Auto Create PR and Merge

on:
  push:
    branches:
      - 'claude/**'

jobs:
  auto-pr-and-merge:
    name: Create PR and Auto-Merge
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          CI: true

      - name: Check if PR exists
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(gh pr list --head "${{ github.ref_name }}" --base main --json number --jq '.[0].number')
          if [ -z "$PR_NUMBER" ]; then
            echo "pr_exists=false" >> $GITHUB_OUTPUT
          else
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_exists == 'false'
        id: create-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_URL=$(gh pr create \
            --base main \
            --head "${{ github.ref_name }}" \
            --title "Auto-merge: ${{ github.ref_name }}" \
            --body "ðŸ¤– Automated PR from CI/CD pipeline

          ## Changes
          - Branch: \`${{ github.ref_name }}\`
          - Commit: \`${{ github.sha }}\`
          - Build: âœ… Passed

          This PR will be automatically merged if all checks pass." \
            --label "auto-merge")

          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

          PR_NUMBER=$(echo $PR_URL | grep -oP '\d+$')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Wait for checks
        run: sleep 10

      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ steps.check-pr.outputs.pr_exists }}" = "true" ]; then
            PR_NUMBER="${{ steps.check-pr.outputs.pr_number }}"
          else
            PR_NUMBER="${{ steps.create-pr.outputs.pr_number }}"
          fi

          gh pr merge $PR_NUMBER --auto --merge --delete-branch || true

      - name: Merge PR immediately
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ steps.check-pr.outputs.pr_exists }}" = "true" ]; then
            PR_NUMBER="${{ steps.check-pr.outputs.pr_number }}"
          else
            PR_NUMBER="${{ steps.create-pr.outputs.pr_number }}"
          fi

          echo "Attempting to merge PR #$PR_NUMBER"
          gh pr merge $PR_NUMBER --merge --delete-branch --admin || echo "Merge requires manual approval or has conflicts"

      - name: Summary
        run: |
          echo "## Auto-Merge Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "PR has been created and will be merged automatically." >> $GITHUB_STEP_SUMMARY
